name: Build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: tauri-app/ui/package-lock.json

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Setup vcpkg
        run: |
          git clone https://github.com/microsoft/vcpkg.git C:\vcpkg
          C:\vcpkg\bootstrap-vcpkg.bat
          echo "VCPKG_ROOT=C:\vcpkg" >> $env:GITHUB_ENV
          echo "C:\vcpkg" >> $env:GITHUB_PATH

      - name: Cache vcpkg packages
        uses: actions/cache@v4
        id: vcpkg-cache
        with:
          path: C:\vcpkg\installed
          key: vcpkg-x64-windows-static-x264-fdk-aac-v1

      - name: Install native dependencies
        if: steps.vcpkg-cache.outputs.cache-hit != 'true'
        run: |
          C:\vcpkg\vcpkg install x264:x64-windows-static fdk-aac:x64-windows-static
        env:
          VCPKG_DEFAULT_TRIPLET: x64-windows-static

      - name: Configure pkg-config for Rust
        run: |
          echo "PKG_CONFIG_PATH=C:\vcpkg\installed\x64-windows-static\lib\pkgconfig" >> $env:GITHUB_ENV

      - name: Install frontend dependencies
        run: |
          cd tauri-app/ui
          npm install

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Clippy
        run: cargo clippy --all-targets -- -D warnings

      - name: Build
        run: cargo build --release

      - name: Install Tauri CLI
        run: cargo install tauri-cli

      - name: Build Tauri app
        run: |
          cd tauri-app
          cargo tauri build

      - name: Upload MSI installer
        uses: actions/upload-artifact@v4
        with:
          name: broadcaster-windows-msi
          path: tauri-app/target/release/bundle/msi/*.msi
          if-no-files-found: error

      - name: Upload portable exe
        uses: actions/upload-artifact@v4
        with:
          name: broadcaster-windows-exe
          path: tauri-app/target/release/broadcaster.exe
          if-no-files-found: error

  # Release job - only runs on version tags
  release:
    needs: build-windows
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    permissions:
      contents: write

    steps:
      - name: Download MSI artifact
        uses: actions/download-artifact@v4
        with:
          name: broadcaster-windows-msi
          path: artifacts/msi

      - name: Download EXE artifact
        uses: actions/download-artifact@v4
        with:
          name: broadcaster-windows-exe
          path: artifacts/exe

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/msi/*.msi
            artifacts/exe/broadcaster.exe
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref, '-') }}
